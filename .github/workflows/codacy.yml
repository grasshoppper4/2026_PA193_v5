name: Codacy Security Scan

on:
  push:
    branches: ["main", "master"]
  pull_request:
    branches: ["main", "master"]

jobs:
  codacy-security-scan:
    name: Run Codacy and prepare SARIF runs
    runs-on: ubuntu-latest
    permissions:
      contents: read

    outputs:
      matrix: ${{ steps.matrix.outputs.matrix }}

    steps:
      - uses: actions/checkout@v4

      - name: Run Codacy Analysis CLI
        uses: codacy/codacy-analysis-cli-action@master
        with:
          output: results.sarif
          format: sarif
          gh-code-scanning-compat: true
          max-allowed-issues: 2147483647

          # âœ… Option 2: do not fail the job if some tools (e.g., trivy) fail
          fail-if-incomplete: false

      - name: Build upload matrix from SARIF runs
        id: matrix
        shell: bash
        run: |
          RUNS=$(jq '.runs | length' results.sarif)
          if [ "$RUNS" -eq 0 ]; then
            echo 'matrix={"include":[]}' >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "matrix=$(jq -nc --argjson n "$RUNS" '{include:[range(0;n) | {run:.}] }')" >> "$GITHUB_OUTPUT"

      - name: Upload SARIF artifact
        uses: actions/upload-artifact@v4
        with:
          name: codacy-sarif
          path: results.sarif

  upload-codacy-sarif:
    name: Upload SARIF runs to GitHub Code Scanning
    needs: codacy-security-scan
    runs-on: ubuntu-latest
    if: ${{ fromJson(needs.codacy-security-scan.outputs.matrix).include[0] != null }}
    permissions:
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.codacy-security-scan.outputs.matrix) }}

    steps:
      - name: Download SARIF artifact
        uses: actions/download-artifact@v4
        with:
          name: codacy-sarif

      - name: Extract SARIF run
        shell: bash
        run: |
          idx='${{ matrix.run }}'
          jq --argjson i "$idx" \
            '{ "version": .version, "$schema": ."$schema", "runs": [ .runs[$i] ] }' \
            results.sarif > "results-run-${idx}.sarif"

      - name: Upload SARIF run
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: results-run-${{ matrix.run }}.sarif
          category: codacy-${{ matrix.run }}
